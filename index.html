<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JavaScript Calculator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f4f4f4;
        }
        
        .calculator {
            border: 1px solid #ccc;
            border-radius: 10px;
            width: 300px;
            background-color: #fff;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        .display {
            padding: 20px;
            text-align: right;
            background-color: #f8f8f8;
            border-bottom: 1px solid #eee;
        }
        
        .display-input {
            width: 100%;
            border: none;
            font-size: 2em;
            text-align: right;
            background-color: transparent;
            outline: none;
        }
        
        .buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1px;
            background-color: #ddd;
        }
        
        button {
            border: none;
            padding: 20px;
            font-size: 1.2em;
            cursor: pointer;
            background-color: #fff;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #f0f0f0;
        }
        
        .operator {
            background-color: #f0f0f0;
            font-weight: bold;
        }
        
        .equals {
            background-color: #4CAF50;
            color: white;
            grid-column: span 2;
        }
        
        .equals:hover {
            background-color: #45a049;
        }
        
        .clear {
            background-color: #f44336;
            color: white;
        }
        
        .clear:hover {
            background-color: #d32f2f;
        }
        
        .error {
            color: #f44336;
        }
    </style>
</head>
<body>
    <div class="calculator">
        <div class="display">
            <input type="text" class="display-input" id="display" readonly>
        </div>
        <div class="buttons">
            <button class="clear" onclick="clearDisplay()">C</button>
            <button onclick="backspace()">←</button>
            <button class="operator" onclick="appendToDisplay('/')">/</button>
            <button class="operator" onclick="appendToDisplay('*')">×</button>
            
            <button onclick="appendToDisplay('7')">7</button>
            <button onclick="appendToDisplay('8')">8</button>
            <button onclick="appendToDisplay('9')">9</button>
            <button class="operator" onclick="appendToDisplay('-')">-</button>
            
            <button onclick="appendToDisplay('4')">4</button>
            <button onclick="appendToDisplay('5')">5</button>
            <button onclick="appendToDisplay('6')">6</button>
            <button class="operator" onclick="appendToDisplay('+')">+</button>
            
            <button onclick="appendToDisplay('1')">1</button>
            <button onclick="appendToDisplay('2')">2</button>
            <button onclick="appendToDisplay('3')">3</button>
            <button class="operator" onclick="calculate()">=</button>
            
            <button onclick="appendToDisplay('0')">0</button>
            <button onclick="appendToDisplay('.')">.</button>
            <button class="equals" onclick="calculate()">=</button>
        </div>
    </div>

    <script>
        const display = document.getElementById('display');
        let lastResult = null;
        let lastInputWasOperator = false;
        let errorState = false;
        
        function appendToDisplay(value) {
            // If in error state, clear display on any new input
            if (errorState) {
                if (/[0-9.]/.test(value)) {
                    clearDisplay();
                    errorState = false;
                } else {
                    return; // Ignore operators if in error state
                }
            }
            
            const isOperator = /[\+\-\*\/]/.test(value);
            const isDecimal = value === '.';
            const isZero = value === '0';
            const currentValue = display.value;
            const lastChar = currentValue.slice(-1);
            
            // Prevent operators at start (except - for negative numbers)
            if (isOperator && currentValue === '' && value !== '-') {
                return;
            }
            
            // Prevent multiple decimal points in a number
            if (isDecimal) {
                const parts = currentValue.split(/[\+\-\*\/]/);
                const currentNumber = parts[parts.length - 1];
                if (currentNumber.includes('.')) {
                    return;
                }
            }
            
            // Prevent leading zeros (except single zero or zero before decimal)
            if (isZero && currentValue === '0') {
                return; // Don't allow multiple zeros at start
            }
            
            // Prevent leading zeros after operator (like 5+000)
            if (isZero && lastInputWasOperator) {
                const parts = currentValue.split(/[\+\-\*\/]/);
                const lastNumber = parts[parts.length - 1];
                if (lastNumber === '0') {
                    return;
                }
            }
            
            // If last input was a result and user starts with operator, use the result
            if (lastResult !== null && isOperator) {
                display.value = lastResult + value;
                lastResult = null;
                lastInputWasOperator = true;
                return;
            }
            
            // If last input was a result and user starts with number, clear display
            if (lastResult !== null && /[0-9]/.test(value)) {
                display.value = '';
                lastResult = null;
                lastInputWasOperator = false;
            }
            
            // Handle operator input
            if (isOperator) {
                // Prevent multiple operators in sequence (except for minus after another operator for negative numbers)
                if (lastInputWasOperator) {
                    // Allow changing the operator unless it would create an invalid sequence
                    if (value === '-' && !/[\-]/.test(lastChar)) {
                        // Allow minus for negative numbers after another operator
                        display.value += value;
                    } else {
                        // Replace the last operator with the new one
                        display.value = currentValue.slice(0, -1) + value;
                    }
                    lastInputWasOperator = true;
                    return;
                }
                
                // Prevent operator after decimal point
                if (lastChar === '.') {
                    return;
                }
                
                lastInputWasOperator = true;
            } else if (isDecimal) {
                // Prevent decimal point after operator
                if (lastInputWasOperator) {
                    return;
                }
                
                lastInputWasOperator = false;
            } else {
                lastInputWasOperator = false;
            }
            
            display.value += value;
        }
        
        function clearDisplay() {
            display.value = '';
            lastResult = null;
            lastInputWasOperator = false;
            errorState = false;
            display.classList.remove('error');
        }
        
        function backspace() {
            if (errorState) {
                clearDisplay();
                return;
            }
            
            const currentValue = display.value;
            if (currentValue.length === 0) return;
            
            const lastChar = currentValue.slice(-1);
            display.value = currentValue.slice(0, -1);
            
            // Update lastInputWasOperator flag
            if (/[\+\-\*\/]/.test(lastChar)) {
                const newLastChar = display.value.slice(-1);
                lastInputWasOperator = /[\+\-\*\/]/.test(newLastChar);
            } else {
                lastInputWasOperator = false;
            }
            
            // If we deleted the last character of a result, clear the result flag
            if (display.value === '') {
                lastResult = null;
            }
        }
        
        function calculate() {
            if (errorState) {
                clearDisplay();
                return;
            }
            
            try {
                if (display.value === '') {
                    return;
                }
                
                // Replace × with * for proper evaluation
                const expression = display.value.replace(/×/g, '*');
                
                // Check for invalid expressions ending with operator
                if (/[\+\-\*\/]$/.test(expression)) {
                    showError('Invalid expression');
                    return;
                }
                
                // Check for division by zero
                if (expression.includes('/0')) {
                    // Check if it's exactly 0/0
                    if (expression === '0/0') {
                        showError('Undefined (0/0)');
                        return;
                    }
                    // Check if it's something like 5/0
                    const parts = expression.split('/');
                    if (parts[1] === '0' || parts[1] === '0.') {
                        showError('Cannot divide by zero');
                        return;
                    }
                }
                
                // Handle negative numbers at the start of the expression
                let evalExpression = expression;
                if (evalExpression.startsWith('-')) {
                    evalExpression = '0' + evalExpression;
                }
                
                // Handle sequences like 5+-3 by converting to 5+(-3)
                evalExpression = evalExpression.replace(/([+\-*/])(\-)/g, '$1($2');
                
                const result = eval(evalExpression);
                if (isNaN(result)) {
                    showError('Invalid operation');
                } else if (!isFinite(result)) {
                    showError('Infinity');
                } else {
                    // Format the result to avoid long decimals
                    const formattedResult = Number.isInteger(result) ? result : parseFloat(result.toFixed(10));
                    display.value = formattedResult;
                    lastResult = formattedResult;
                    lastInputWasOperator = false;
                }
            } catch (error) {
                showError('Error');
            }
        }
        
        function showError(message) {
            display.value = message;
            display.classList.add('error');
            errorState = true;
            lastResult = null;
            lastInputWasOperator = false;
        }
        
        // Add keyboard support
        document.addEventListener('keydown', function(event) {
            const key = event.key;
            
            if (/[0-9]/.test(key)) {
                appendToDisplay(key);
                event.preventDefault();
            } else if (key === '.') {
                appendToDisplay('.');
                event.preventDefault();
            } else if (/[\+\-\*\/]/.test(key)) {
                appendToDisplay(key);
                event.preventDefault();
            } else if (key === 'Enter' || key === '=') {
                calculate();
                event.preventDefault();
            } else if (key === 'Escape') {
                clearDisplay();
                event.preventDefault();
            } else if (key === 'Backspace') {
                backspace();
                event.preventDefault();
            }
        });
    </script>
</body>
</html>